# Функция управления перерывами сотрудников

## Дата реализации
05.11.2025

## Описание
Реализована полная функциональность для управления перерывами сотрудников в расписании (обед, перерыв, совещание, другое).

## Что было сделано

### Backend (Django)

#### 1. Модель Break (`backend/apps/calendar/models.py`)
- Создана модель `Break` с полями:
  - `employee` - связь с сотрудником
  - `break_type` - тип перерыва (lunch/break/meeting/other)
  - `date` - дата перерыва
  - `start_time` - время начала
  - `end_time` - время окончания
  - `note` - примечание
  - `is_recurring` - флаг повторяющегося перерыва
  - `created_at`, `updated_at` - временные метки

#### 2. Сериализатор (`backend/apps/calendar/serializers.py`)
- Создан `BreakSerializer` с:
  - Валидацией времени начала и окончания
  - Проверкой на пересечения перерывов
  - Автоматическим созданием повторяющихся перерывов на 30 дней вперед

#### 3. ViewSet (`backend/apps/calendar/views.py`)
- Создан `BreakViewSet` с:
  - CRUD операциями для перерывов
  - Фильтрацией по сотруднику, дате, типу перерыва
  - Действием `delete_recurring` для удаления всех повторяющихся перерывов

#### 4. URL маршруты (`backend/apps/calendar/urls.py`)
- Добавлен роутер для `/api/v1/calendar/breaks/`

#### 5. Админка (`backend/apps/calendar/admin.py`)
- Добавлена регистрация модели Break в Django Admin

#### 6. Миграция
- Создана миграция `0004_add_break_model.py`
- Миграция успешно применена к базе данных

### Frontend (Vue.js)

#### 1. API модуль (`frontend/src/api/calendar.js`)
- Создан новый API модуль для работы с календарем
- Добавлены методы для работы с breaks:
  - `getBreaks(params)` - получение списка перерывов
  - `createBreak(data)` - создание перерыва
  - `updateBreak(id, data)` - обновление перерыва
  - `deleteBreak(id)` - удаление перерыва
  - `deleteRecurringBreaks(params)` - удаление повторяющихся перерывов

#### 2. Компонент BreakModal (`frontend/src/components/BreakModal.vue`)
- **Исправлено:**
  - Убран атрибут `disabled` с селекта сотрудника (теперь работает условно: блокируется только если сотрудник уже выбран)
  - Изменен тип перерыва по умолчанию с 'lunch' на 'break'
- **Добавлено:**
  - Интеграция с API календаря
  - Форматирование времени для отправки на сервер
  - Watch-эры для отслеживания изменений employee и date
  - Обработка ошибок при сохранении

#### 3. Страница расписания (`frontend/src/pages/SchedulePage.vue`)
- Обновлена функция `handleBreakSaved` для перезагрузки расписания после сохранения

## API Endpoints

### Получить список перерывов
```
GET /api/v1/calendar/breaks/
Параметры: employee, date_from, date_to, break_type, is_recurring
```

### Создать перерыв
```
POST /api/v1/calendar/breaks/
Body: {
  "employee": 1,
  "break_type": "break",
  "date": "2025-11-05",
  "start_time": "12:00:00",
  "end_time": "13:00:00",
  "note": "Обеденный перерыв",
  "is_recurring": false
}
```

### Обновить перерыв
```
PATCH /api/v1/calendar/breaks/{id}/
Body: {поля для обновления}
```

### Удалить перерыв
```
DELETE /api/v1/calendar/breaks/{id}/
```

### Удалить повторяющиеся перерывы
```
DELETE /api/v1/calendar/breaks/delete_recurring/
Параметры: employee, start_time, end_time, break_type
```

## Типы перерывов

- `lunch` - Обед
- `break` - Перерыв
- `meeting` - Совещание
- `other` - Другое

## Функциональность

### Создание перерыва
1. Пользователь открывает модальное окно "Добавить перерыв" из меню сотрудника
2. Выбирает сотрудника (если не выбран автоматически)
3. Выбирает тип перерыва
4. Указывает время начала и окончания
5. Указывает дату
6. Опционально добавляет примечание
7. Может отметить перерыв как повторяющийся (будет создан на 30 дней вперед)

### Повторяющиеся перерывы
- При установке флага "Повторяющийся перерыв" создаются перерывы на следующие 30 дней
- Система проверяет, не существует ли уже перерыв на эту дату перед созданием

### Валидация
- Время начала должно быть раньше времени окончания
- Перерывы не могут пересекаться для одного сотрудника в один день

## Тестирование

### Как протестировать:
1. Откройте страницу расписания
2. Нажмите на меню сотрудника (три точки в заголовке колонки)
3. Выберите "Добавить перерыв"
4. Заполните форму и сохраните
5. Проверьте, что перерыв сохранился на сервере

## Будущие улучшения

1. Отображение перерывов в сетке расписания (визуальные блоки)
2. Редактирование существующих перерывов
3. Drag & drop для перемещения перерывов
4. Цветовая кодировка по типам перерывов
5. Экспорт расписания с учетом перерывов
6. Уведомления о приближающихся перерывах

## Известные ограничения

1. Перерывы пока не отображаются визуально на сетке расписания (только через API)
2. Повторяющиеся перерывы создаются на фиксированный период (30 дней)

## Файлы, которые были изменены

### Backend:
- `backend/apps/calendar/models.py` - добавлена модель Break
- `backend/apps/calendar/serializers.py` - добавлен BreakSerializer
- `backend/apps/calendar/views.py` - добавлен BreakViewSet
- `backend/apps/calendar/urls.py` - добавлен роутер для breaks
- `backend/apps/calendar/admin.py` - добавлена регистрация Break в админке
- `backend/apps/calendar/migrations/0004_add_break_model.py` - миграция БД

### Frontend:
- `frontend/src/api/calendar.js` - новый API модуль
- `frontend/src/components/BreakModal.vue` - исправления и интеграция с API
- `frontend/src/pages/SchedulePage.vue` - обновлена обработка сохранения перерывов

