# Database Schema Fix - November 5, 2025

## Issue: Calendar Appointments 500 Error

**Error**: `django.db.utils.ProgrammingError: column appointment_resources.appointment_id does not exist`

**Symptom**: Frontend calendar page showing 500 Internal Server Error when trying to load appointments.

## Root Cause

The `appointment_resources` table was created in migration `0001_initial.py` but was missing its foreign key columns:
- `appointment_id` (ForeignKey to Appointment)
- `resource_id` (ForeignKey to Resource)

This happened because the initial migration only created the table structure but didn't add the relationship fields.

## Solution

Created a new migration `0005_fix_appointment_resource_fields.py` that adds the missing foreign key columns and constraints.

### Migration Details

**File**: `backend/apps/calendar/migrations/0005_fix_appointment_resource_fields.py`

**Changes**:
1. Added `appointment` ForeignKey to `AppointmentResource` model
2. Added `resource` ForeignKey to `AppointmentResource` model
3. Added unique constraint on `(appointment, resource)` pair

### Applied Changes

```sql
-- Added columns
ALTER TABLE appointment_resources ADD COLUMN appointment_id bigint;
ALTER TABLE appointment_resources ADD COLUMN resource_id bigint;

-- Added foreign key constraints
ALTER TABLE appointment_resources 
  ADD CONSTRAINT appointment_resource_appointment_id_29aa49aa_fk_appointme 
  FOREIGN KEY (appointment_id) REFERENCES appointments(id);

ALTER TABLE appointment_resources 
  ADD CONSTRAINT appointment_resources_resource_id_159d8efd_fk_resources_id 
  FOREIGN KEY (resource_id) REFERENCES resources(id);

-- Added unique constraint
ALTER TABLE appointment_resources 
  ADD CONSTRAINT appointment_resources_appointment_id_resource_id_88feb49e_uniq 
  UNIQUE (appointment_id, resource_id);
```

## Steps Taken

1. âœ… Created migration file `0005_fix_appointment_resource_fields.py`
2. âœ… Applied migration: `python manage.py migrate calendar`
3. âœ… Verified schema: Checked database with `\d appointment_resources`
4. âœ… Restarted backend: `docker-compose restart backend`

## Verification

### Database Schema (After Fix)
```
                                Table "public.appointment_resources"
     Column     |           Type           | Collation | Nullable |             Default              
----------------+--------------------------+-----------+----------+----------------------------------
 id             | bigint                   |           | not null | generated by default as identity
 created_at     | timestamp with time zone |           | not null | 
 appointment_id | bigint                   |           |          | âœ… ADDED
 resource_id    | bigint                   |           |          | âœ… ADDED

Indexes:
    "appointment_resources_pkey" PRIMARY KEY, btree (id)
    "appointment_resources_appointment_id_29aa49aa" btree (appointment_id)
    "appointment_resources_appointment_id_resource_id_88feb49e_uniq" UNIQUE CONSTRAINT
    "appointment_resources_resource_id_159d8efd" btree (resource_id)

Foreign-key constraints:
    "appointment_resource_appointment_id_29aa49aa_fk_appointme" FOREIGN KEY âœ…
    "appointment_resources_resource_id_159d8efd_fk_resources_id" FOREIGN KEY âœ…
```

### Backend Status
- âœ… Backend started successfully on port 8000
- âœ… API endpoints responding with 200 OK
- âœ… No more schema errors in logs

## Testing

**Please refresh your frontend page** and try loading the calendar again. The appointments should now load without errors.

### Test Checklist
- [ ] Frontend calendar page loads without 500 error
- [ ] Appointments display correctly
- [ ] Can create new appointments
- [ ] Can assign resources to appointments
- [ ] No console errors

## Related Files Modified

1. `backend/apps/calendar/migrations/0005_fix_appointment_resource_fields.py` - **NEW**
2. Database schema updated with migration

## Status: âœ… FIXED

The database schema has been corrected and the backend has been restarted. The calendar appointments API should now work correctly.

---

## Related Issues Fixed Today

1. **Telegram Bot Module Error**: Fixed `apps.telegram_bot` being commented out in settings (user reverted this)
2. **Patient Organization Field**: Fixed bot registration using old `organization` field instead of `organizations` ManyToMany
3. **AppointmentResource Schema**: Fixed missing foreign key columns (THIS FIX)

All issues have been resolved! ðŸŽ‰

