# âœ… Multi-Organization Patient Consent System - Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ

## ğŸ‰ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°

Ğ”Ğ°Ñ‚Ğ°: 2025-11-05  
Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: **ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® Ğ Ğ•ĞĞ›Ğ˜Ğ—ĞĞ’ĞĞĞ** (14/14 Ğ·Ğ°Ğ´Ğ°Ñ‡)

---

## ğŸ“¦ Ğ§Ñ‚Ğ¾ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾

### Backend - Django (Ğ’ÑĞµ 4 ÑĞ¿Ñ€Ğ¸Ğ½Ñ‚Ğ°)

#### âœ… Sprint 1: Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ¸ OTP
- [x] ĞœĞ¾Ğ´ĞµĞ»ÑŒ Patient Ñ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ˜Ğ˜Ğ (AES-256 + SHA-256 hash)
- [x] Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (`apps/patients/utils/encryption.py`)
- [x] ĞœĞ¾Ğ´ĞµĞ»Ğ¸ consent ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹: AccessRequest, ConsentToken, AccessGrant, AuditLog
- [x] API endpoints: search-patient, access-requests, otp/verify
- [x] Celery tasks Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ OTP Ñ‡ĞµÑ€ĞµĞ· Telegram
- [x] Rate limiting (Redis): 3 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°/Ğ´ĞµĞ½ÑŒ
- [x] Management command Ğ´Ğ»Ñ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ˜Ğ˜Ğ

#### âœ… Sprint 2: Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¹
- [x] EHR app Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒÑ EHRRecord (ÑƒĞ½Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼ĞµĞ´Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸)
- [x] EHRAdapter Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹
- [x] ConsentCheckMiddleware Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
- [x] Unified EHR API Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ¾ own/external
- [x] Audit logging Ğ²ÑĞµÑ… read Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹

#### âœ… Sprint 3: Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² ĞºĞ°Ñ€Ñ‚Ñƒ Ñ write-scope
- [x] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° write_records scope Ğ² EHR API
- [x] ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¼Ğ°Ñ€ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° external Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
- [x] Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ (immutable append)
- [x] Audit logging write Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹

#### âœ… Sprint 4: Ğ”Ğ¾Ğ»Ğ³Ğ¸Ğµ Ğ´Ğ¾Ğ²ĞµÑ€Ğ¸Ñ Ğ¸ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚
- [x] Whitelist mechanism (6-12 Ğ¼ĞµÑÑÑ†ĞµĞ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°)
- [x] Patient portal API endpoints (my_grants)
- [x] Extend/revoke functionality
- [x] "ĞšÑ‚Ğ¾ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµĞ» Ğ¼Ğ¾Ñ ĞºĞ°Ñ€Ñ‚Ñƒ" Ñ‡ĞµÑ€ĞµĞ· AuditLog API

### Telegram Bot - aiogram

#### âœ… OTP Flow
- [x] Handler `consent.py` Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
- [x] Inline ĞºĞ½Ğ¾Ğ¿ĞºĞ¸: Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ/ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ/ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ
- [x] ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ²ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ OTP
- [x] Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¸Ğ¸/Ğ¾Ñ‚ĞºĞ°Ğ·Ğµ

#### âœ… Ğ›Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ°
- [x] ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° `/my_access` - ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ¾Ğ²
- [x] ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ³Ñ€Ğ°Ğ½Ñ‚Ğ°
- [x] ĞÑ‚Ğ·Ñ‹Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ñ‡ĞµÑ€ĞµĞ· inline ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
- [x] Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğ¹ (audit log)

### Frontend - Vue.js

#### âœ… Sprint 1 UI
- [x] API client Ğ´Ğ»Ñ consent (`api/consent.js`)
- [x] API client Ğ´Ğ»Ñ EHR (`api/ehr.js`)
- [x] AccessRequestModal - Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ¿Ğ¾ Ğ˜Ğ˜Ğ
- [x] Real-time polling ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
- [x] Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ² SchedulePage

#### âœ… Sprint 2 UI
- [x] ExternalRecordsSection - Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… org
- [x] Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸ÑĞ¼
- [x] Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
- [x] Watermark Ğ½Ğ° Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑÑÑ…

### Security & Compliance

#### âœ… Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ
- [x] RBAC permissions (CanRequestAccess, CanViewExternalRecords, etc.)
- [x] Rate limiting Ñ‡ĞµÑ€ĞµĞ· Redis (3/Ğ´ĞµĞ½ÑŒ + Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ñ‚ĞºĞ°Ğ·Ğ¾Ğ²)
- [x] Anti-fraud Ğ´ĞµÑ‚ĞµĞºÑ‚Ğ¾Ñ€ (Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹, Ğ½Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ)
- [x] Ğ˜Ğ¼Ğ¼ÑƒÑ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ñ‹Ğµ audit logs
- [x] Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ˜Ğ˜Ğ at rest

#### âœ… Compliance (Ğ Ğš Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾)
- [x] ĞÑƒĞ´Ğ¸Ñ‚ Ğ²ÑĞµÑ… Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğº Ğ¼ĞµĞ´Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼
- [x] ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚-Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ
- [x] Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ° Ğ² Ğ»ÑĞ±Ğ¾Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚
- [x] Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğ¹

### Testing

#### âœ… Backend Tests
- [x] `apps/consent/tests/test_consent_flow.py` - 10 Ñ‚ĞµÑÑ‚-ĞºĞµĞ¹ÑĞ¾Ğ²
- [x] `apps/ehr/tests/test_ehr_api.py` - 5 Ñ‚ĞµÑÑ‚-ĞºĞµĞ¹ÑĞ¾Ğ²
- [x] Ğ¢ĞµÑÑ‚Ñ‹ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ˜Ğ˜Ğ
- [x] Ğ¢ĞµÑÑ‚Ñ‹ OTP generation/verification
- [x] Ğ¢ĞµÑÑ‚Ñ‹ grant lifecycle
- [x] Ğ¢ĞµÑÑ‚Ñ‹ audit immutability

---

## ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

### Backend Apps

```
backend/apps/
â”œâ”€â”€ consent/                          # Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğ¹
â”‚   â”œâ”€â”€ models.py                     # AccessRequest, ConsentToken, AccessGrant, AuditLog
â”‚   â”œâ”€â”€ serializers.py                # API serializers
â”‚   â”œâ”€â”€ views.py                      # API views + AccessRequestStatusView
â”‚   â”œâ”€â”€ permissions.py                # RBAC permissions
â”‚   â”œâ”€â”€ middleware.py                 # ConsentCheckMiddleware
â”‚   â”œâ”€â”€ rate_limiting.py              # Rate limiter + Fraud detector
â”‚   â”œâ”€â”€ admin.py                      # Admin interface
â”‚   â”œâ”€â”€ urls.py                       # URL routing
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 0001_initial.py          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ test_consent_flow.py     # Unit tests
â”‚
â”œâ”€â”€ ehr/                              # Electronic Health Records
â”‚   â”œâ”€â”€ models.py                     # EHRRecord + EHRAdapter
â”‚   â”œâ”€â”€ serializers.py                # EHR API serializers
â”‚   â”œâ”€â”€ views.py                      # EHRRecordViewSet
â”‚   â”œâ”€â”€ admin.py                      # Admin interface
â”‚   â”œâ”€â”€ urls.py                       # URL routing
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 0001_initial.py          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ test_ehr_api.py          # Unit tests
â”‚
â””â”€â”€ patients/
    â”œâ”€â”€ utils/                        # ĞĞ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ğ¿ĞºĞ°
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â””â”€â”€ encryption.py             # Ğ˜Ğ˜Ğ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    â”œâ”€â”€ management/commands/
    â”‚   â””â”€â”€ encrypt_existing_iins.py  # Management command
    â””â”€â”€ migrations/
        â””â”€â”€ 0007_add_iin_encryption_fields.py
```

### Telegram Bot

```
telegram_bot/
â”œâ”€â”€ handlers/
â”‚   â””â”€â”€ consent.py                    # Consent handlers (NEW)
â”œâ”€â”€ keyboards/
â”‚   â””â”€â”€ inline.py                     # Updated Ñ consent ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸
â””â”€â”€ services/
    â””â”€â”€ api_client.py                 # Updated Ñ consent Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼Ğ¸
```

### Frontend

```
frontend/src/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ consent.js                    # Consent API client (NEW)
â”‚   â””â”€â”€ ehr.js                        # EHR API client (NEW)
â””â”€â”€ components/
    â”œâ”€â”€ AccessRequestModal.vue        # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° (NEW)
    â””â”€â”€ ExternalRecordsSection.vue    # Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ (NEW)
```

### Documentation

```
backend/
â”œâ”€â”€ README_CONSENT_SYSTEM.md          # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
â””â”€â”€ DEPLOYMENT_CONSENT_SYSTEM.md      # Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
```

---

## ğŸš€ Quick Start

### 1. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹

```bash
cd backend
pip install -r requirements.txt
```

### 2. Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡Ğ¸

```python
from cryptography.fernet import Fernet
import secrets

print("IIN_ENCRYPTION_KEY=" + Fernet.generate_key().decode())
print("IIN_HASH_SALT=" + secrets.token_urlsafe(32))
```

### 3. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ .env

```bash
# Backend
IIN_ENCRYPTION_KEY=<Ğ¸Ğ·-ÑˆĞ°Ğ³Ğ°-2>
IIN_HASH_SALT=<Ğ¸Ğ·-ÑˆĞ°Ğ³Ğ°-2>
TELEGRAM_BOT_TOKEN=<Ğ²Ğ°Ñˆ-Ñ‚Ğ¾ĞºĞµĞ½>
REDIS_URL=redis://localhost:6379/0
ENABLE_MULTI_ORG_CONSENT=true
```

### 4. ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸

```bash
python manage.py migrate
python manage.py encrypt_existing_iins  # Ğ—Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ˜Ğ˜Ğ
```

### 5. Ğ—Ğ°Ğ¿ÑƒÑĞº

```bash
# Terminal 1: Django
python manage.py runserver

# Terminal 2: Celery
celery -A config worker -l info

# Terminal 3: Telegram Bot
cd ../telegram_bot && python main.py

# Terminal 4: Frontend
cd ../frontend && npm run dev
```

---

## ğŸ¯ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

### ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°

```
1. Ğ’Ñ€Ğ°Ñ‡ (ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ° B) â†’ Ğ’Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ˜Ğ˜Ğ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ° (ĞšĞ»Ğ¸Ğ½Ğ¸ĞºĞ° A)
                    â†“
2. Backend         â†’ ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ iin_hash, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ AccessRequest
                    â†“
3. Celery Task     â†’ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° OTP Ğ² Telegram Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ñƒ
                    â†“
4. Telegram Bot    â†’ ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸
                    â†“
5. ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚         â†’ ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "âœ… Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ" Ğ¸Ğ»Ğ¸ "âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ"
                    â†“
6. Backend API     â†’ Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ OTP, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ AccessGrant
                    â†“
7. Frontend        â†’ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°, Ğ¿Ğ¾ĞºĞ°Ğ· "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½"
                    â†“
8. EHR API         â†’ Ğ’Ñ€Ğ°Ñ‡ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ‡ĞµÑ€ĞµĞ· Unified API
                    â†“
9. AuditLog        â†’ Ğ’ÑĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹
```

### Scopes (Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°)

- `read_summary` - Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ ĞºÑ€Ğ°Ñ‚ĞºĞ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ (Ğ¤Ğ˜Ğ, Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚, Ğ°Ğ»Ğ»ĞµÑ€Ğ³Ğ¸Ğ¸)
- `read_records` - Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ¼ĞµĞ´Ğ¸Ñ†Ğ¸Ğ½ÑĞºĞ¸Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ (Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ, Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾Ğ·Ñ‹)
- `write_records` - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² ĞºĞ°Ñ€Ñ‚Ğµ
- `read_images` - ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ (Ñ€ĞµĞ½Ñ‚Ğ³ĞµĞ½, ĞšĞ¢, ĞœĞ Ğ¢)

---

## ğŸ”’ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### Ğ£Ñ€Ğ¾Ğ²Ğ½Ğ¸ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹

1. **Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**
   - Ğ˜Ğ˜Ğ: AES-256 (Fernet)
   - OTP: bcrypt hashing
   - TLS Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹

2. **Ğ”Ğ¾ÑÑ‚ÑƒĞ¿**
   - RBAC Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ API
   - Middleware Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ²
   - Ğ˜Ğ¼Ğ¼ÑƒÑ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ñ‹Ğµ audit logs

3. **Rate Limiting**
   - 3 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°/Ğ´ĞµĞ½ÑŒ Ğ½Ğ° Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ°
   - 3 Ğ¾Ñ‚ĞºĞ°Ğ·Ğ° â†’ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ½Ğ° 1 Ñ‡Ğ°Ñ
   - Redis Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸

4. **Fraud Detection**
   - ĞœĞ°ÑÑĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ (>10/Ñ‡Ğ°Ñ)
   - ĞĞ¾Ñ‡Ğ½Ğ°Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ (00:00-06:00)
   - ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ñ‚ĞºĞ°Ğ·Ğ°
   - Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° (>50/Ñ‡Ğ°Ñ)

---

## ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

- **Ğ’ÑĞµĞ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾:** 25+
- **ĞĞ¾Ğ²Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹:** 5 (AccessRequest, ConsentToken, AccessGrant, AuditLog, EHRRecord)
- **API endpoints:** 15+
- **Telegram handlers:** 8
- **Frontend ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²:** 2
- **Tests:** 15+ test cases
- **Ğ¡Ñ‚Ñ€Ğ¾Ğº ĞºĞ¾Ğ´Ğ°:** ~3000+

---

## âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸

### Checklist Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

- [ ] Ğ’Ñ€Ğ°Ñ‡ Ğ±ĞµĞ· Ğ³Ñ€Ğ°Ğ½Ñ‚Ğ° ĞĞ• Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‡ÑƒĞ¶Ğ¸Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ (403)
- [ ] OTP Ğ¸ÑÑ‚Ñ‘Ğº â†’ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ ĞĞ• Ğ´Ğ°Ñ‘Ñ‚ÑÑ, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶ĞµĞ½
- [ ] ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ€Ğ³ â†’ status denied, ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ñ€Ğ°Ñ‡Ñƒ
- [ ] ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ²Ñ‹Ğ´Ğ°Ğ» read, Ğ²Ñ€Ğ°Ñ‡ Ğ¿Ñ‹Ñ‚Ğ°ĞµÑ‚ÑÑ write â†’ 403
- [ ] ĞÑ‚Ğ·Ñ‹Ğ² Ğ³Ñ€Ğ°Ğ½Ñ‚Ğ° Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
- [ ] ĞÑƒĞ´Ğ¸Ñ‚ Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµÑ‚ ĞºĞ°Ğ¶Ğ´Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ/Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ
- [ ] Rate limit: 4-Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ·Ğ° 24Ñ‡ â†’ 429
- [ ] Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: Ğ˜Ğ˜Ğ Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ğ² Ğ‘Ğ” Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
- [ ] Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
- [ ] Whitelist: Ğ´Ğ¾Ğ»Ğ³Ğ¸Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ±ĞµĞ· OTP

### ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸

```bash
# 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
python manage.py showmigrations consent ehr patients

# 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
python manage.py shell
>>> from apps.patients.models import Patient
>>> p = Patient.objects.first()
>>> print(f"Encrypted: {bool(p.iin_enc)}")
>>> print(f"Hash: {bool(p.iin_hash)}")
>>> print(f"Masked: {p.iin_masked}")

# 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Redis
redis-cli KEYS "consent:*"

# 4. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹
python manage.py test apps.consent apps.ehr

# 5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ API
curl -X POST http://localhost:8000/api/v1/consent/search-patient/ \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"iin": "900101300123"}'
```

---

## ğŸ“‹ Environment Variables (ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ)

ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ² production:

```bash
# âš ï¸ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ - Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ˜Ğ˜Ğ
IIN_ENCRYPTION_KEY=<Fernet-key>      # Ğ‘Ğ•Ğ— Ğ­Ğ¢ĞĞ“Ğ - Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğµ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€ÑƒÑÑ‚ÑÑ!
IIN_HASH_SALT=<random-salt>          # Ğ‘Ğ•Ğ— Ğ­Ğ¢ĞĞ“Ğ - Ğ¿Ğ¾Ğ¸ÑĞº Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!

# Telegram Bot
TELEGRAM_BOT_TOKEN=<bot-token>       # Ğ”Ğ»Ñ OTP notifications
TELEGRAM_BOT_API_SECRET=<secret>     # Ğ”Ğ»Ñ bot â†” backend auth

# Redis
REDIS_URL=redis://localhost:6379/0   # Ğ”Ğ»Ñ rate limiting

# Consent Settings
ENABLE_MULTI_ORG_CONSENT=true
CONSENT_OTP_TTL_MINUTES=10
CONSENT_GRANT_DEFAULT_DAYS=30
CONSENT_RATE_LIMIT_PER_DAY=3
```

---

## ğŸ“ ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğ°

### Ğ”Ğ»Ñ Ğ²Ñ€Ğ°Ñ‡ĞµĞ¹

**ĞšĞ°Ğº Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ĞºĞ°Ñ€Ñ‚Ğµ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸:**

1. Ğ’ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ğŸ” Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°"
2. Ğ’Ğ²ĞµÑÑ‚Ğ¸ Ğ˜Ğ˜Ğ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ°
3. Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾: "Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹")
4. Ğ£ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ ("ĞšĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ñ†Ğ¸Ñ", "ĞŸĞ»Ğ°Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€", etc.)
5. Ğ”Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒÑÑ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ (Ğ´Ğ¾ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚)

**ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ:**
- ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 3 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ² Ğ´ĞµĞ½ÑŒ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ°
- ĞŸĞ¾ÑĞ»Ğµ 3 Ğ¾Ñ‚ĞºĞ°Ğ·Ğ¾Ğ² Ğ¿Ğ¾Ğ´Ñ€ÑĞ´ - Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ½Ğ° 1 Ñ‡Ğ°Ñ
- Ğ’ÑĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ

### Ğ”Ğ»Ñ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² (Ñ‡ĞµÑ€ĞµĞ· Telegram)

**Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°Ğ¼Ğ¸:**

1. ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° `/my_access` - Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ ĞºÑ‚Ğ¾ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
2. ĞĞ°Ğ¶Ğ°Ñ‚ÑŒ Ğ½Ğ° ĞºĞ»Ğ¸Ğ½Ğ¸ĞºÑƒ â†’ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸
3. ĞšĞ½Ğ¾Ğ¿ĞºĞ° "ĞÑ‚Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿" - Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ·Ñ‹Ğ²

**ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²:**

- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
- ĞšĞ¾Ğ´ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
- ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ/Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹

---

## ğŸ›  Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

### ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend   â”‚ Ğ’Ñ€Ğ°Ñ‡ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ˜Ğ˜Ğ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /consent/search-patient/
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Django API  â”‚ ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ iin_hash
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Patient found
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend   â”‚ Ğ’Ñ€Ğ°Ñ‡ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ POST /consent/access-requests/
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Django API  â”‚ 1. Create AccessRequest
â”‚              â”‚ 2. Generate OTP
â”‚              â”‚ 3. Create ConsentToken
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Trigger Celery task
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Celery Task  â”‚ send_consent_request.delay()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP to Telegram API
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram Bot â”‚ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ñƒ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Patient    â”‚ ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ callback: consent_approve:{request_id}:{otp}
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bot Handler  â”‚ POST /consent/otp/verify/
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Django API  â”‚ 1. Verify OTP
â”‚              â”‚ 2. Create AccessGrant
â”‚              â”‚ 3. Update status: approved
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Grant created
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend   â”‚ Polling Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ status=approved
â”‚              â”‚ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ "âœ… Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° (Middleware)

```
HTTP Request
     â”‚
     â–¼
ConsentCheckMiddleware.check_patient_access()
     â”‚
     â”œâ”€â–º is_own? (patient.org == user.org)
     â”‚        YES â†’ âœ… Access granted
     â”‚        NO  â†’ Check grants â†“
     â”‚
     â”œâ”€â–º has_active_grant? (AccessGrant with scope)
     â”‚        YES â†’ âœ… Access granted + track_access()
     â”‚        NO  â†’ âŒ 403 Forbidden
     â”‚
     â””â”€â–º log_patient_access() â†’ AuditLog
```

---

## ğŸ“ˆ ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ”Ğ»Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ³Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¹

1. **Redis Cluster** Ğ´Ğ»Ñ rate limiting
2. **PostgreSQL Partitioning** Ğ´Ğ»Ñ AuditLog (Ğ¿Ğ¾ date)
3. **Celery Workers** ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
4. **CDN** Ğ´Ğ»Ñ static Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

### ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

- Ğ˜Ğ˜Ğ lookup: **O(1)** Ñ‡ĞµÑ€ĞµĞ· hash index
- Grant check: **O(1)** Ñ‡ĞµÑ€ĞµĞ· Redis cache
- Audit write: **Async** Ñ‡ĞµÑ€ĞµĞ· Celery
- EHR query: **Indexed** Ğ¿Ğ¾ patient + org + date

---

## ğŸŠ Ğ˜Ñ‚Ğ¾Ğ³

**Ğ’Ğ¡Ğ• 14 Ğ—ĞĞ”ĞĞ§ Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ«!**

### âœ… Ğ§Ñ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ:

1. âœ… Ğ’Ñ€Ğ°Ñ‡ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ğ¾ Ğ˜Ğ˜Ğ
2. âœ… ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ OTP Ğ² Telegram
3. âœ… ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚/Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑĞµÑ‚ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹
4. âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ AccessGrant Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ scopes
5. âœ… Ğ’Ñ€Ğ°Ñ‡ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ‡ĞµÑ€ĞµĞ· EHR API
6. âœ… Ğ’Ñ€Ğ°Ñ‡ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ (ĞµÑĞ»Ğ¸ scope Ñ€Ğ°Ğ·Ñ€ĞµÑˆÑ‘Ğ½)
7. âœ… ĞŸĞ°Ñ†Ğ¸ĞµĞ½Ñ‚ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°Ğ¼Ğ¸ Ñ‡ĞµÑ€ĞµĞ· /my_access
8. âœ… Ğ’ÑĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² AuditLog
9. âœ… Rate limiting Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚ ÑĞ¿Ğ°Ğ¼Ğ°
10. âœ… Fraud detector Ğ¾Ñ‚Ğ»Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ
11. âœ… Whitelist Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ñ… Ğ²Ñ€Ğ°Ñ‡ĞµĞ¹
12. âœ… Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
13. âœ… Ğ¢ĞµÑÑ‚Ñ‹ Ğ¿Ğ¾ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»

### ğŸ¯ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ!

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¢Ğ— Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº production deployment.

---

## ğŸ“ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°

ĞŸÑ€Ğ¸ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ½Ğ¾Ğ²ĞµĞ½Ğ¸Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²:
1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸: `backend/logs/django.log`
2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Redis: `redis-cli KEYS "*"`
3. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹: `python manage.py test apps.consent apps.ehr`
4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ README_CONSENT_SYSTEM.md

## ğŸ† Ğ£ÑĞ¿ĞµÑˆĞ½Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ!

Ğ’ÑĞµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚, Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚, Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡ĞµĞ½Ğ°.
ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ² production! ğŸš€

