<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>План лечения</title>
    <style>
        @page { size: A4; margin: 2cm; }
        body { font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.5; }
        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { font-size: 16pt; font-weight: bold; margin: 10px 0; }
        .section { margin-bottom: 20px; }
        .section-title { font-weight: bold; font-size: 13pt; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
        .field { margin: 5px 0; }
        .field-label { font-weight: bold; min-width: 150px; display: inline-block; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        table, th, td { border: 1px solid #000; }
        th, td { padding: 6px; text-align: left; font-size: 10pt; }
        th { background-color: #e8e8e8; font-weight: bold; }
        .stage { margin: 20px 0; padding: 15px; background: #f5f5f5; border-left: 4px solid #2196F3; }
        .stage-title { font-size: 12pt; font-weight: bold; margin-bottom: 10px; }
        .total-row { background-color: #ffe8a1; font-weight: bold; }
        .signature { margin-top: 30px; }
        .signature-line { border-bottom: 1px solid #000; width: 250px; display: inline-block; }
        .status-badge { padding: 4px 12px; border-radius: 4px; display: inline-block; font-weight: bold; }
        .status-active { background: #4CAF50; color: white; }
        .status-draft { background: #9E9E9E; color: white; }
        .status-completed { background: #2196F3; color: white; }
        .status-cancelled { background: #F44336; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ПЛАН ЛЕЧЕНИЯ</h1>
        <p>№ {{ plan.id }} от {{ plan.created_at|date:"d.m.Y" }}</p>
        <p>{{ organization.name }}</p>
    </div>

    <div class="section">
        <div class="section-title">Информация о плане</div>
        <div class="field"><span class="field-label">Пациент:</span> {{ plan.patient.full_name }}</div>
        <div class="field"><span class="field-label">Дата рождения:</span> {{ plan.patient.birth_date }} ({{ plan.patient.age }} лет)</div>
        <div class="field"><span class="field-label">ИИН:</span> {{ plan.patient.iin|default:"Не указан" }}</div>
        <div class="field"><span class="field-label">Телефон:</span> {{ plan.patient.phone }}</div>
        <div class="field" style="margin-top: 15px;">
            <span class="field-label">Название плана:</span> <strong>{{ plan.title }}</strong>
        </div>
        {% if plan.description %}
        <div class="field"><span class="field-label">Описание:</span> {{ plan.description }}</div>
        {% endif %}
        <div class="field"><span class="field-label">Период лечения:</span> {{ plan.start_date }} 
        {% if plan.end_date %}- {{ plan.end_date }}{% else %}- (не завершен){% endif %}</div>
        <div class="field">
            <span class="field-label">Статус:</span>
            <span class="status-badge status-{{ plan.status }}">{{ plan.get_status_display }}</span>
        </div>
        {% if plan.total_cost_frozen %}
        <div class="field"><span class="field-label">Цены:</span> <strong>ЗАФИКСИРОВАНЫ</strong> ✓</div>
        {% endif %}
    </div>

    <div class="section">
        <div class="section-title">Этапы лечения</div>
        
        {% for stage in plan.stages.all %}
        <div class="stage">
            <div class="stage-title">
                Этап {{ stage.order }}: {{ stage.title }}
                <span style="float: right; font-size: 10pt; font-weight: normal;">
                    Статус: {{ stage.get_status_display }}
                    {% if stage.start_date %} | {{ stage.start_date }}{% endif %}
                </span>
            </div>
            {% if stage.description %}
            <p style="font-size: 10pt; margin: 5px 0;">{{ stage.description }}</p>
            {% endif %}
            
            <table style="margin-top: 10px;">
                <thead>
                    <tr>
                        <th style="width: 5%;">№</th>
                        <th style="width: 35%;">Услуга/Процедура</th>
                        <th style="width: 10%;">Кол-во план</th>
                        <th style="width: 10%;">Выполнено</th>
                        <th style="width: 12%;">Цена (₸)</th>
                        <th style="width: 10%;">Скидка %</th>
                        <th style="width: 13%;">Итого (₸)</th>
                        <th style="width: 5%;">Зуб</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in stage.items.all %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ item.description }}</td>
                        <td style="text-align: center;">{{ item.qty_planned }}</td>
                        <td style="text-align: center;">{{ item.qty_completed }}</td>
                        <td style="text-align: right;">{{ item.unit_price }}</td>
                        <td style="text-align: center;">{{ item.discount_percent }}%</td>
                        <td style="text-align: right;"><strong>{{ item.calculate_total }}</strong></td>
                        <td style="text-align: center;">{{ item.tooth_number|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td colspan="6" style="text-align: right;"><strong>Итого по этапу:</strong></td>
                        <td style="text-align: right;"><strong>{{ stage.calculate_total_cost }} ₸</strong></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>

    <div class="section">
        <div class="section-title">ОБЩАЯ СТОИМОСТЬ</div>
        <table style="width: 50%; margin: 0 auto;">
            <tr>
                <td style="text-align: right; padding: 15px; font-size: 14pt;">
                    <strong>ИТОГО:</strong>
                </td>
                <td style="text-align: right; padding: 15px; font-size: 14pt;">
                    <strong>{{ plan.total_cost }} ₸</strong>
                </td>
            </tr>
        </table>
        {% if plan.total_cost_frozen %}
        <p style="text-align: center; color: #4CAF50; font-weight: bold;">
            ✓ Стоимость зафиксирована на момент составления плана
        </p>
        {% endif %}
    </div>

    <div class="signature">
        <p>Лечащий врач: <span class="signature-line"></span></p>
        <p style="margin-top: 15px;">Пациент ознакомлен: <span class="signature-line"></span></p>
        <p style="margin-top: 15px;">Дата: <span class="signature-line">{{ current_date }}</span></p>
    </div>

    <p style="margin-top: 40px; text-align: center; font-size: 9pt;">
        План лечения сформирован {{ current_date }} | {{ organization.name }}
    </p>
</body>
</html>

