<template>
  <n-modal
    v-model:show="visible"
    :title="isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞' : '–ù–æ–≤—ã–π –ø–∞—Ü–∏–µ–Ω—Ç'"
    preset="card"
    style="width: 1100px"
    :segmented="{ content: 'soft' }"
  >
    <n-scrollbar style="max-height: 75vh">
      <!-- Tabs -->
      <n-tabs v-model:value="activeTab" type="line" animated>
        <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <n-tab-pane name="general" tab="–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
          <n-form ref="formRef" :model="formData" :rules="rules" label-placement="top">
            <!-- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ -->
            <n-card title="–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Ññ –æ—Ç –¥–¥.–º–º.–≥–≥–≥–≥" :bordered="false">
              <n-button text type="primary">
                üìé –î–æ–±–∞–≤–∏—Ç—å –≤–ª–æ–∂–µ–Ω–∏—è
              </n-button>
            </n-card>

            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
            <n-card title="–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ" :bordered="false" style="margin-top: 16px">
              <n-grid :cols="3" :x-gap="12">
                <n-grid-item>
                  <n-form-item label="–§–∞–º–∏–ª–∏—è" path="last_name">
                    <n-input v-model:value="formData.last_name" placeholder="–§–∞–º–∏–ª–∏—è" />
                  </n-form-item>
                </n-grid-item>
                <n-grid-item>
                  <n-form-item label="–ò–º—è" path="first_name">
                    <n-input v-model:value="formData.first_name" placeholder="–ò–º—è" />
                  </n-form-item>
                </n-grid-item>
                <n-grid-item>
                  <n-form-item label="–û—Ç—á–µ—Å—Ç–≤–æ" path="middle_name">
                    <n-input v-model:value="formData.middle_name" placeholder="–û—Ç—á–µ—Å—Ç–≤–æ" />
                  </n-form-item>
                </n-grid-item>
              </n-grid>

              <n-form-item label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" path="birth_date">
                <n-date-picker
                  v-model:value="formData.birth_date"
                  type="date"
                  placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É"
                  style="width: 100%"
                />
              </n-form-item>

              <n-form-item label="–ü–æ–ª" path="sex">
                <n-radio-group v-model:value="formData.sex">
                  <n-radio value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</n-radio>
                  <n-radio value="M">–ú—É–∂—Å–∫–æ–π</n-radio>
                  <n-radio value="F">–ñ–µ–Ω—Å–∫–∏–π</n-radio>
                </n-radio-group>
              </n-form-item>

              <n-form-item label="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –ø–∞—Ü–∏–µ–Ω—Ç—É" path="notes">
                <n-input
                  v-model:value="formData.notes"
                  type="textarea"
                  :rows="3"
                  placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"
                />
              </n-form-item>

              <n-button text type="primary">
                + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è
              </n-button>
            </n-card>

            <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            <n-card title="–ö–æ–Ω—Ç–∞–∫—Ç—ã" :bordered="false" style="margin-top: 16px">
              <n-form-item label="–¢–µ–ª–µ—Ñ–æ–Ω" path="phone">
                <n-input v-model:value="formData.phone" placeholder="+7 (XXX) XXX-XX-XX" />
              </n-form-item>

              <n-form-item label="E-mail" path="email">
                <n-input v-model:value="formData.email" placeholder="email@example.com" />
              </n-form-item>

              <n-form-item label="–ù–∏–∫–Ω–µ–π–º –≤ Telegram">
                <n-input v-model:value="formData.telegram_nickname" placeholder="@username" />
              </n-form-item>

              <n-space vertical>
                <n-checkbox v-model:checked="formData.consent_newsletters">
                  –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
                </n-checkbox>
                <n-checkbox v-model:checked="formData.consent_egisz">
                  –°–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ –ï–ì–ò–°–ó
                </n-checkbox>
              </n-space>
            </n-card>

            <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã -->
            <n-card title="–î–æ–∫—É–º–µ–Ω—Ç—ã" :bordered="false" style="margin-top: 16px">
              <n-form-item label="–ò–ò–ù" path="iin">
                <n-input v-model:value="formData.iin" placeholder="–í–≤–µ–¥–∏—Ç–µ –ò–ò–ù" />
              </n-form-item>

              <n-divider title-placement="left">–ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</n-divider>

              <n-grid :cols="2" :x-gap="12">
                <n-grid-item>
                  <n-form-item label="–°–µ—Ä–∏—è">
                    <n-input v-model:value="formData.passport_series" placeholder="–°–µ—Ä–∏—è" />
                  </n-form-item>
                </n-grid-item>
                <n-grid-item>
                  <n-form-item label="–ù–æ–º–µ—Ä">
                    <n-input v-model:value="formData.passport_number" placeholder="–ù–æ–º–µ—Ä" />
                  </n-form-item>
                </n-grid-item>
              </n-grid>

              <n-form-item label="–ö–æ–≥–¥–∞ –≤—ã–¥–∞–Ω">
                <n-date-picker
                  v-model:value="formData.passport_issued_date"
                  type="date"
                  style="width: 100%"
                />
              </n-form-item>

              <n-form-item label="–ö–µ–º –≤—ã–¥–∞–Ω">
                <n-input v-model:value="formData.passport_issued_by" placeholder="–û—Ä–≥–∞–Ω –≤—ã–¥–∞—á–∏" />
              </n-form-item>
            </n-card>

            <!-- –î–∏—Å–∫–æ–Ω—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
            <n-card title="–î–∏—Å–∫–æ–Ω—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞" :bordered="false" style="margin-top: 16px">
              <n-grid :cols="2" :x-gap="12">
                <n-grid-item>
                  <n-form-item label="‚Ññ –∫–∞—Ä—Ç—ã">
                    <n-input v-model:value="formData.discount_card" placeholder="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" />
                  </n-form-item>
                </n-grid-item>
                <n-grid-item>
                  <n-form-item label="–°–∫–∏–¥–∫–∞, %">
                    <n-input-number
                      v-model:value="formData.discount_percent"
                      :min="0"
                      :max="100"
                      placeholder="0"
                      style="width: 100%"
                    />
                  </n-form-item>
                </n-grid-item>
              </n-grid>

              <n-text>–°—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫: {{ formData.balance || 0 }} ‚Ç∏</n-text>
            </n-card>

            <!-- –ê–¥—Ä–µ—Å -->
            <n-card title="–ê–¥—Ä–µ—Å" :bordered="false" style="margin-top: 16px">
              <n-form-item label="–ê–¥—Ä–µ—Å" path="address">
                <n-input
                  v-model:value="formData.address"
                  type="textarea"
                  :rows="2"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å"
                />
              </n-form-item>
            </n-card>

            <!-- –ê–Ω–∞–º–Ω–µ–∑ -->
            <n-card title="–ê–Ω–∞–º–Ω–µ–∑" :bordered="false" style="margin-top: 16px">
              <n-form-item label="–ê–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∞–∫—Ü–∏–∏">
                <n-input
                  v-model:value="formData.allergies"
                  type="textarea"
                  :rows="3"
                  placeholder="–û–ø–∏—à–∏—Ç–µ –∞–ª–ª–µ—Ä–≥–∏–∏"
                />
              </n-form-item>

              <n-form-item label="–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è">
                <n-input
                  v-model:value="formData.medical_history"
                  type="textarea"
                  :rows="4"
                  placeholder="–ê–Ω–∞–º–Ω–µ–∑"
                />
              </n-form-item>
            </n-card>
          </n-form>
        </n-tab-pane>

        <!-- –ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–∏ -->
        <n-tab-pane name="history" tab="–ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–∏">
          <n-card title="–í–∏–∑–∏—Ç—ã" :bordered="false">
            <template #header-extra>
              <n-button type="primary" size="small">
                + –ù–æ–≤—ã–π –≤–∏–∑–∏—Ç
              </n-button>
            </template>
            <n-empty v-if="!isEdit" description="–ü–æ–∫–∞ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–∏–∑–∏—Ç–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ">
              <template #extra>
                <n-text>
                  –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                </n-text>
              </template>
            </n-empty>
          </n-card>
        </n-tab-pane>

        <!-- –ú–µ–¥–æ—Å–º–æ—Ç—Ä—ã -->
        <n-tab-pane name="examinations" tab="–ú–µ–¥–æ—Å–º–æ—Ç—Ä—ã">
          <n-card :bordered="false">
            <n-button type="primary">
              + –ù–æ–≤—ã–π –º–µ–¥–æ—Å–º–æ—Ç—Ä
            </n-button>
            <n-empty
              style="margin-top: 24px"
              description="–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∫–∞—Ä—Ç—ã –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞. –ü–æ–∫–∞ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ."
            />
          </n-card>
        </n-tab-pane>

        <!-- –ü–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è -->
        <n-tab-pane name="plans" tab="–ü–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è">
          <n-empty description="–ü–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ" />
        </n-tab-pane>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <n-tab-pane name="stats" tab="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
          <n-empty description="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏–∑–∏—Ç–æ–≤ –∏ –ª–µ—á–µ–Ω–∏—è" />
        </n-tab-pane>

        <!-- –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
        <n-tab-pane name="contacts" tab="–ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤">
          <n-empty description="–ò—Å—Ç–æ—Ä–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –ø–∞—Ü–∏–µ–Ω—Ç–æ–º" />
        </n-tab-pane>
      </n-tabs>
    </n-scrollbar>

    <template #footer>
      <n-space justify="end">
        <n-button @click="handleClose">–û—Ç–º–µ–Ω–∞</n-button>
        <n-button type="warning" @click="handleSave(false)" :loading="saving">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </n-button>
        <n-button type="primary" @click="handleSave(true)" :loading="saving">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å
        </n-button>
      </n-space>
    </template>
  </n-modal>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { useMessage } from 'naive-ui'
import apiClient from '@/api/axios'
import { useAuthStore } from '@/stores/auth'

const props = defineProps({
  show: {
    type: Boolean,
    required: true
  },
  patient: {
    type: Object,
    default: null
  }
})

const emit = defineEmits(['update:show', 'saved'])

const message = useMessage()
const authStore = useAuthStore()
const formRef = ref(null)
const saving = ref(false)
const activeTab = ref('general')

const isEdit = computed(() => !!props.patient)

const visible = computed({
  get: () => props.show,
  set: (value) => emit('update:show', value)
})

// Form data
const formData = ref({
  organization: null,
  first_name: '',
  last_name: '',
  middle_name: '',
  birth_date: null,
  sex: '',
  phone: '',
  email: '',
  address: '',
  iin: '',
  passport_series: '',
  passport_number: '',
  passport_issued_by: '',
  passport_issued_date: null,
  notes: '',
  allergies: '',
  medical_history: '',
  discount_card: '',
  discount_percent: 0,
  balance: 0,
  telegram_nickname: '',
  consent_newsletters: false,
  consent_egisz: false
})

const rules = {
  first_name: { required: true, message: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è', trigger: 'blur' },
  last_name: { required: true, message: '–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é', trigger: 'blur' },
  birth_date: { required: true, type: 'number', message: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è', trigger: 'change' },
  phone: { required: true, message: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω', trigger: 'blur' },
  sex: { required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª', trigger: 'change' }
}

// Watch for patient prop changes
watch(
  () => props.patient,
  (newVal) => {
    if (newVal) {
      formData.value = {
        organization: newVal.organization,
        first_name: newVal.first_name || '',
        last_name: newVal.last_name || '',
        middle_name: newVal.middle_name || '',
        birth_date: newVal.birth_date ? new Date(newVal.birth_date).getTime() : null,
        sex: newVal.sex || '',
        phone: newVal.phone || '',
        email: newVal.email || '',
        address: newVal.address || '',
        iin: newVal.iin || '',
        passport_series: newVal.documents?.passport_series || '',
        passport_number: newVal.documents?.passport_number || '',
        passport_issued_by: newVal.documents?.passport_issued_by || '',
        passport_issued_date: newVal.documents?.passport_issued_date ? new Date(newVal.documents.passport_issued_date).getTime() : null,
        notes: newVal.notes || '',
        allergies: newVal.allergies || '',
        medical_history: newVal.medical_history || '',
        discount_card: '',
        discount_percent: newVal.discount_percent || 0,
        balance: newVal.balance || 0,
        telegram_nickname: '',
        consent_newsletters: newVal.consents?.newsletters || false,
        consent_egisz: newVal.consents?.egisz || false
      }
    } else {
      resetForm()
    }
  },
  { immediate: true }
)

function resetForm() {
  formData.value = {
    organization: authStore.user?.organization || null,
    first_name: '',
    last_name: '',
    middle_name: '',
    birth_date: null,
    sex: '',
    phone: '',
    email: '',
    address: '',
    iin: '',
    passport_series: '',
    passport_number: '',
    passport_issued_by: '',
    passport_issued_date: null,
    notes: '',
    allergies: '',
    medical_history: '',
    discount_card: '',
    discount_percent: 0,
    balance: 0,
    telegram_nickname: '',
    consent_newsletters: false,
    consent_egisz: false
  }
  activeTab.value = 'general'
}

function handleClose() {
  visible.value = false
  resetForm()
}

async function handleSave(closeAfter = false) {
  try {
    await formRef.value?.validate()
    saving.value = true

    const data = {
      organization: formData.value.organization || authStore.user?.organization,
      first_name: formData.value.first_name,
      last_name: formData.value.last_name,
      middle_name: formData.value.middle_name,
      birth_date: formData.value.birth_date ? new Date(formData.value.birth_date).toISOString().split('T')[0] : null,
      sex: formData.value.sex,
      phone: formData.value.phone,
      email: formData.value.email,
      address: formData.value.address,
      iin: formData.value.iin,
      documents: {
        passport_series: formData.value.passport_series,
        passport_number: formData.value.passport_number,
        passport_issued_by: formData.value.passport_issued_by,
        passport_issued_date: formData.value.passport_issued_date ? new Date(formData.value.passport_issued_date).toISOString().split('T')[0] : null
      },
      notes: formData.value.notes,
      allergies: formData.value.allergies,
      medical_history: formData.value.medical_history,
      discount_percent: formData.value.discount_percent,
      consents: {
        newsletters: formData.value.consent_newsletters,
        egisz: formData.value.consent_egisz
      }
    }

    if (isEdit.value) {
      await apiClient.patch(`/patients/patients/${props.patient.id}`, data)
      message.success('–ü–∞—Ü–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω')
    } else {
      await apiClient.post('/patients/patients', data)
      message.success('–ü–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω')
    }

    emit('saved')

    if (closeAfter) {
      handleClose()
    } else {
      resetForm()
    }
  } catch (error) {
    console.error('Error saving patient:', error)
    if (error.response?.data) {
      const errors = error.response.data
      const errorMsg = typeof errors === 'string' ? errors : JSON.stringify(errors)
      message.error('–û—à–∏–±–∫–∞: ' + errorMsg)
    } else {
      message.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞')
    }
  } finally {
    saving.value = false
  }
}
</script>

<style scoped lang="scss">
@import '@/styles/tokens.scss';

:deep(.n-card) {
  margin-bottom: 16px;
}

:deep(.n-card__header) {
  font-weight: 600;
  font-size: 16px;
}
</style>

